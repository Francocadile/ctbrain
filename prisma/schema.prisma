model Team {
  id                        String                     @id @default(cuid())
  name                      String                     @unique
  slug                      String                     @unique
  isActive                  Boolean                    @default(true)
  logoUrl                   String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  members                   UserTeam[]
  rivals                    Rival[]
  feedback                  PlayerFeedback[]
  sessions                  Session[]
  places                    Place[]
  plannerPrefs              PlannerPrefs?
  scoutingCategories        ScoutingCategory[]
  scoutingPlayers           ScoutingPlayer[]
  videos                    TeamVideo[]
  reports                   Report[]
  players                   Player[]
  routines                  Routine[]
  exercises                 Exercise[]
  rivalReports              RivalReport[]
  deviceTokens              DeviceToken[]
  plannerDayTypes           PlannerDayType[]
  plannerDayTypeAssignments PlannerDayTypeAssignment[]
  protocols                 Protocol[]
  nextRivalFile             NextRivalFile?
  Program                   Program[]
  routinePrograms           RoutineProgram[]
  blockTemplates            BlockTemplate[]
}

model NextRivalFile {
  id         String   @id @default(cuid())
  teamId     String   @unique
  fileUrl    String
  fileName   String
  uploadedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========= Enums base =========
enum Role {
  SUPERADMIN
  ADMIN
  CT
  MEDICO
  JUGADOR
  DIRECTIVO
}

enum TeamRole {
  ADMIN
  CT
  MEDICO
  JUGADOR
  DIRECTIVO
}

enum SessionType {
  GENERAL
  FUERZA
  TACTICA
  AEROBICO
  RECUPERACION
}

enum ExerciseUsage {
  ROUTINE
  SESSION
}

model GlobalConfig {
  id         String   @id @default(cuid())
  systemName String
  logoUrl    String?
  mainColor  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ========= Enums clínicos =========
enum ClinicalStatus {
  BAJA
  REINTEGRO
  LIMITADA
  ALTA
}

enum LeaveStage {
  PARTIDO
  ENTRENAMIENTO
  EXTRADEPORTIVO
}

enum LeaveKind {
  LESION
  ENFERMEDAD
}

enum Laterality {
  IZQ
  DER
  BILATERAL
  NA
}

enum Severity {
  LEVE
  MODERADA
  SEVERA
}

enum Mechanism {
  SOBRECARGA
  IMPACTO
  TORSION
  ESTIRAMIENTO
  RECIDIVA
  OTRO
}

enum SystemAffected {
  RESPIRATORIO
  GASTROINTESTINAL
  OTORRINO
  DERMATOLOGICO
  GENERAL
  OTRO
}

enum IllAptitude {
  SOLO_GIMNASIO
  AEROBICO_SUAVE
  CHARLAS_TACTICO
  NINGUNO
}

// ========= Modelos existentes =========
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String?
  passwordHash String?
  role         Role    @default(JUGADOR)

  isApproved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  passwordChangedAt DateTime?

  sessions          Session[]            @relation("UserSessions")
  rpeEntries        RPEEntry[]
  wellnessEntries   WellnessEntry[]
  // plannerPrefs: ahora es por equipo (no por usuario)
  clinicalEntries   ClinicalEntry[]
  protocolsAsPlayer Protocol[]           @relation("ProtocolPlayer")
  protocolsCreated  Protocol[]           @relation("ProtocolCreatedBy")
  teams             UserTeam[]
  reports           Report[]
  players           Player[]
  routineShares     RoutinePlayerShare[]
  videoAudience     TeamVideoAudience[]
  resetTokens       PasswordResetToken[]
  deviceTokens      DeviceToken[]
}

model UserTeam {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  role      TeamRole
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

model Session {
  id          String      @id @default(cuid())
  title       String
  description String?
  date        DateTime
  type        SessionType @default(GENERAL)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  createdBy String
  user      User   @relation("UserSessions", fields: [createdBy], references: [id], onDelete: Cascade)
  teamId    String
  team      Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Ejercicios de biblioteca que se originaron en esta sesión/celda
  originExercises Exercise[]

  // Snapshot de rutinas vinculadas a esta sesión
  routineSnapshots SessionRoutineItem[]

  @@index([date])
  @@index([type])
  @@index([createdBy])
  @@index([teamId])
  @@index([teamId, date])
}

model SessionRoutineItem {
  id String @id @default(cuid())

  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  routineId     String?
  routineItemId String?

  blockName String?
  blockType String?

  title        String
  sets         Int?
  reps         Int?
  load         String?
  tempo        String?
  rest         String?
  notes        String?
  athleteNotes String?

  order Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([routineId])
}

model Rival {
  id      String  @id @default(cuid())
  teamId  String
  name    String
  logoUrl String?

  coach                String?
  baseSystem           String?
  nextMatchDate        DateTime?
  nextMatchCompetition String?

  planCharlaUrl  String?
  planReport     Json?   @default("{}")
  planVideos     Json?   @default("[]")
  planStats      Json?   @default("{}")
  planNotes      Json?   @default("{}")
  planVisibility Json?   @default("{}")

  planSquad Json? @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@index([teamId])
  @@index([nextMatchDate])
}

model RivalReport {
  id          String   @id @default(cuid())
  teamId      String
  matchDate   DateTime
  rivalName   String
  competition String?
  notes       String?
  videos      Json? // lista de videos [{title, url}]

  team Team @relation(fields: [teamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PlayerFeedback {
  id        String   @id @default(cuid())
  teamId    String
  playerId  String
  subject   String?  @db.VarChar(120)
  text      String
  rating    Int?
  createdBy String
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId, playerId])
  @@index([teamId, createdAt])
}

model Place {
  id        String   @id @default(cuid())
  name      String
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, name])
  @@index([teamId])
}

model ExerciseKind {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Biblioteca de ejercicios por equipo
model Exercise {
  id       String  @id @default(cuid())
  teamId   String? // null = ejercicio global cargado por el sistema
  team     Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  name     String  @unique
  zone     String?
  videoUrl String?

  usage ExerciseUsage @default(ROUTINE)

  // Sesión (celda) de origen, si aplica
  originSessionId String?
  originSession   Session? @relation(fields: [originSessionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con rutinas
  routineItems RoutineItem[]

  // snapshot de los datos de la sesión de donde salió (opcional)
  sessionMeta Json?

  @@index([originSessionId])
}

model RPEEntry {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date         DateTime
  session      Int      @default(1)
  sessionLabel String?
  sessionUid   String?

  rpe      Int
  duration Int?
  load     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date, session], name: "userId_date_session")
  @@index([date])
  @@index([userId, date, session])
  @@index([date, session])
  @@index([sessionUid])
}

model WellnessEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime

  sleepQuality   Int
  sleepHours     Float?
  fatigue        Int
  muscleSoreness Int
  stress         Int
  mood           Int
  comment        String?

  total Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date], name: "userId_date")
  @@index([date])
  @@index([userId, date])
}

model PlannerPrefs {
  id            String   @id @default(cuid())
  teamId        String
  rowLabels     Json     @default("{}")
  places        Json     @default("[]")
  contentRowIds Json?
  metaRowIds    Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId])
}

// ========= Clínico =========
model ClinicalEntry {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date   DateTime
  status ClinicalStatus

  leaveStage LeaveStage?
  leaveKind  LeaveKind?

  diagnosis  String?
  bodyPart   String?
  laterality Laterality?
  mechanism  Mechanism?
  severity   Severity?

  illSystem        SystemAffected?
  illSymptoms      String?
  illContagious    Boolean?
  illIsolationDays Int?
  illAptitude      IllAptitude?
  feverMax         Float?

  startDate            DateTime?
  daysPlanned          Int?
  expectedReturn       DateTime?
  expectedReturnManual Boolean?  @default(false)

  capMinutes          Int?
  noSprint            Boolean @default(false)
  noChangeOfDirection Boolean @default(false)
  gymOnly             Boolean @default(false)
  noContact           Boolean @default(false)

  notes        String?
  medSignature String?

  protocolObjectives String?
  protocolTasks      String?
  protocolControls   String?
  protocolCriteria   String?

  protocols Protocol[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date], name: "userId_date")
  @@index([date])
  @@index([status, date])
  @@index([leaveKind])
  @@index([bodyPart])
  @@index([userId, date])
}

// ========= Protocolos médicos =========

enum ProtocolStatus {
  DRAFT
  ACTIVE
  FINISHED
}

enum ProtocolBlockType {
  GYM
  FIELD
  POOL
  THERAPY
  MOBILITY
  SUPPLEMENT
  OTHER
}

model Protocol {
  id              String  @id @default(cuid())
  teamId          String
  playerId        String
  clinicalEntryId String?

  createdById String

  title         String?
  injuryContext String?
  status        ProtocolStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stages ProtocolStage[]

  team          Team           @relation(fields: [teamId], references: [id])
  player        User           @relation("ProtocolPlayer", fields: [playerId], references: [id])
  createdBy     User           @relation("ProtocolCreatedBy", fields: [createdById], references: [id])
  clinicalEntry ClinicalEntry? @relation(fields: [clinicalEntryId], references: [id])

  @@index([teamId])
  @@index([playerId])
  @@index([clinicalEntryId])
}

model ProtocolStage {
  id         String @id @default(cuid())
  protocolId String

  date  DateTime
  title String?
  order Int

  notes String?

  blocks ProtocolBlock[]

  protocol Protocol @relation(fields: [protocolId], references: [id])

  @@index([protocolId, order])
  @@index([date])
}

model ProtocolBlock {
  id      String @id @default(cuid())
  stageId String
  order   Int

  type      ProtocolBlockType
  content   String
  intensity String?
  volume    String?
  notes     String?

  stage ProtocolStage @relation(fields: [stageId], references: [id])

  @@index([stageId, order])
}

// ========= Scouting =========
enum ScoutingStatus {
  ACTIVO
  WATCHLIST
  DESCARTADO
}

enum PlayerStatus {
  ACTIVO
  LESIONADO
  RECUPERACION
  ALTA_PARCIAL
  ALTA_TOTAL
}

model ScoutingCategory {
  id     String  @id @default(cuid())
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  nombre String
  slug   String
  orden  Int     @default(0)
  color  String?
  activa Boolean @default(true)

  players ScoutingPlayer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, slug])
  @@unique([teamId, nombre])
  @@index([teamId, orden])
}

model Player {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  name        String
  shirtNumber Int?
  position    String?
  photoUrl    String?
  birthDate   DateTime?

  status PlayerStatus @default(ACTIVO)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model ScoutingPlayer {
  id        String         @id @default(cuid())
  teamId    String?
  team      Team?          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  fullName  String
  positions String[]       @default([])
  club      String?
  estado    ScoutingStatus @default(ACTIVO)

  categoriaId String?
  categoria   ScoutingCategory? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  agentName   String?
  agentPhone  String?
  agentEmail  String?
  playerPhone String?
  playerEmail String?
  instagram   String?

  videos String[] @default([])
  notes  String?
  rating Int?
  tags   String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([teamId, categoriaId])
  @@index([teamId, estado])
  @@index([teamId, fullName])
}

model Report {
  id                 String   @id @default(cuid())
  teamId             String
  title              String
  summary            String?
  content            String
  type               String
  authorId           String
  visibleToDirectivo Boolean  @default(true)
  createdAt          DateTime @default(now())

  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([teamId, createdAt])
  @@index([authorId])
}

model TeamVideo {
  id                 String                @id @default(cuid())
  teamId             String
  url                String
  title              String
  notes              String?
  type               String // "propio" | "rival"
  visibleToDirectivo Boolean               @default(true)
  audienceMode       TeamVideoAudienceMode @default(ALL)
  createdAt          DateTime              @default(now())

  team     Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  audience TeamVideoAudience[]

  @@index([teamId, createdAt])
}

enum TeamVideoAudienceMode {
  ALL
  SELECTED
}

model TeamVideoAudience {
  id          String   @id @default(cuid())
  teamVideoId String
  userId      String
  createdAt   DateTime @default(now())

  teamVideo TeamVideo @relation(fields: [teamVideoId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamVideoId, userId])
  @@index([teamVideoId])
  @@index([userId])
}

model DeviceToken {
  id     String  @id @default(cuid())
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  team   Team?   @relation(fields: [teamId], references: [id])
  teamId String?

  platform   String // "ios" | "android"
  pushToken  String // token FCM
  deviceId   String?
  appVersion String?

  isActive   Boolean  @default(true)
  lastSeenAt DateTime @updatedAt
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([pushToken])
}

model PlannerDayType {
  id        String  @id @default(cuid())
  teamId    String
  team      Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  key       String
  label     String
  color     String
  order     Int
  isDefault Boolean @default(false)

  @@unique([teamId, key])
  @@index([teamId, order])
}

model PlannerDayTypeAssignment {
  id         String @id @default(cuid())
  teamId     String
  team       Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  ymd        String
  turn       String
  dayTypeKey String

  @@unique([teamId, ymd, turn])
  @@index([teamId, ymd])
}

enum RoutineVisibility {
  STAFF_ONLY
  PLAYER_VISIBLE
}

enum RoutineShareMode {
  STAFF_ONLY
  ALL_PLAYERS
  SELECTED_PLAYERS
}

enum RoutineBlockType {
  WARMUP
  MAIN
  COOLDOWN
  ACCESSORY
}

model Routine {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  title       String
  description String?

  // nuevos campos Rutinas PRO
  goal            String?
  visibility      RoutineVisibility? @default(STAFF_ONLY)
  notesForAthlete String?

  shareMode         RoutineShareMode     @default(STAFF_ONLY)
  sharedWithPlayers RoutinePlayerShare[]

  items  RoutineItem[]
  blocks RoutineBlock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model RoutineBlock {
  id        String  @id @default(cuid())
  routineId String
  routine   Routine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  name        String
  order       Int
  description String?

  // nuevo: tipo opcional del bloque (warmup, main, etc.)
  type RoutineBlockType?

  items RoutineItem[]

  updatedAt DateTime @default(now()) @updatedAt

  @@index([routineId])
}

model RoutineItem {
  id        String  @id @default(cuid())
  routineId String
  routine   Routine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Int

  // relación opcional a bloque
  blockId String?
  block   RoutineBlock? @relation(fields: [blockId], references: [id])

  // parámetros de entrenamiento
  exerciseId String?
  exercise   Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  // Mantener compatibilidad con lo actual
  exerciseName String?
  sets         Int?
  reps         Int?
  load         String?
  tempo        String?
  rest         String?
  notes        String?
  athleteNotes String?
  videoUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([routineId])
  @@index([blockId])
}

model RoutinePlayerShare {
  id String @id @default(cuid())

  routineId String
  playerId  String

  routine Routine @relation(fields: [routineId], references: [id], onDelete: Cascade)
  player  User    @relation(fields: [playerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([routineId, playerId])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

// =========================
// Programas (Fase 1) - ADITIVO
// =========================

enum ProgramWeekday {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

model Program {
  id          String  @id @default(cuid())
  teamId      String
  title       String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team  Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  weeks ProgramWeek[]

  @@index([teamId])
}

model ProgramWeek {
  id         String  @id @default(cuid())
  programId  String
  teamId     String
  weekNumber Int
  label      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program Program      @relation(fields: [programId], references: [id], onDelete: Cascade)
  days    ProgramDay[]

  @@unique([programId, weekNumber])
  @@index([programId])
  @@index([teamId])
  @@index([programId, teamId])
}

model ProgramDay {
  id        String         @id @default(cuid())
  weekId    String
  teamId    String
  weekday   ProgramWeekday
  routineId String

  titleOverride String?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  week ProgramWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@unique([weekId, weekday])
  @@index([weekId])
  @@index([teamId])
  @@index([routineId])
  @@index([teamId, routineId])
  @@index([weekId, teamId])
}

// =========================
// Rutinas: Programas -> Fases -> Playlist (ADITIVO)
// =========================

model RoutineProgram {
  id          String  @id @default(cuid())
  teamId      String
  title       String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team   Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  phases RoutineProgramPhase[]
  days   RoutineProgramDay[]

  @@index([teamId])
}

model RoutineProgramPhase {
  id        String @id @default(cuid())
  programId String
  title     String
  order     Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program  RoutineProgram              @relation(fields: [programId], references: [id], onDelete: Cascade)
  routines RoutineProgramPhaseRoutine[]

  @@index([programId])
}

model RoutineProgramPhaseRoutine {
  id        String @id @default(cuid())
  phaseId   String
  routineId String
  order     Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  phase RoutineProgramPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@unique([phaseId, routineId])
  @@index([phaseId])
  @@index([routineId])
}

// =========================
// Rutinas: Mapping semanal/día (produce RoutineProgramDay)
// =========================

model RoutineProgramDay {
  id        String  @id @default(cuid())
  programId String

  // 0..27, donde dayIndex = (weekNumber-1)*7 + weekdayIndex(MON=0..SUN=6)
  dayIndex Int
  label    String?
  routineId String

  program RoutineProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, dayIndex])
  @@index([programId])
  @@index([routineId])
}

// =========================
// Block Templates - ADITIVO
// =========================

model BlockTemplate {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  title     String
  // Copia de RoutineBlock.type en formato string (WARMUP/MAIN/...)
  blockType String

  items     BlockTemplateItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model BlockTemplateItem {
  id         String   @id @default(cuid())
  templateId String
  template   BlockTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Referencia blanda: si el ejercicio se borra, lo omitimos al insertar.
  exerciseId String

  order Int

  sets  Int?
  reps  Int?
  load  String?
  tempo String?
  rest  String?
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([exerciseId])
  @@unique([templateId, exerciseId, order])
}
