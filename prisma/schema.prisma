model Team {
  id        String           @id @default(cuid())
  name      String           @unique
  slug      String           @unique
  isActive  Boolean          @default(true)
  logoUrl   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  members   UserTeam[]
  rivals    Rival[]
  feedback  PlayerFeedback[]
  sessions  Session[]
  places    Place[]
  plannerPrefs PlannerPrefs[]
  scoutingCategories ScoutingCategory[]
  scoutingPlayers    ScoutingPlayer[]
  videos    TeamVideo[]
  reports   Report[]
  players   Player[]
  routines  Routine[]
}
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========= Enums base =========
enum Role {
  SUPERADMIN
  ADMIN
  CT
  MEDICO
  JUGADOR
  DIRECTIVO
}

enum TeamRole {
  ADMIN
  CT
  MEDICO
  JUGADOR
  DIRECTIVO
}

enum SessionType {
  GENERAL
  FUERZA
  TACTICA
  AEROBICO
  RECUPERACION
}

model GlobalConfig {
  id         String   @id @default(cuid())
  systemName String
  logoUrl    String?
  mainColor  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
// ========= Enums clínicos =========
enum ClinicalStatus {
  BAJA
  REINTEGRO
  LIMITADA
  ALTA
}

enum LeaveStage {
  PARTIDO
  ENTRENAMIENTO
  EXTRADEPORTIVO
}

enum LeaveKind {
  LESION
  ENFERMEDAD
}

enum Laterality {
  IZQ
  DER
  BILATERAL
  NA
}

enum Severity {
  LEVE
  MODERADA
  SEVERA
}

enum Mechanism {
  SOBRECARGA
  IMPACTO
  TORSION
  ESTIRAMIENTO
  RECIDIVA
  OTRO
}

enum SystemAffected {
  RESPIRATORIO
  GASTROINTESTINAL
  OTORRINO
  DERMATOLOGICO
  GENERAL
  OTRO
}

enum IllAptitude {
  SOLO_GIMNASIO
  AEROBICO_SUAVE
  CHARLAS_TACTICO
  NINGUNO
}

// ========= Modelos existentes =========
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String?
  role         Role     @default(JUGADOR)

  isApproved Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sessions        Session[]      @relation("UserSessions")
  rpeEntries      RPEEntry[]
  wellnessEntries WellnessEntry[]
  plannerPrefs    PlannerPrefs[]
  exercises       Exercise[]
  clinicalEntries ClinicalEntry[]
  teams           UserTeam[]
  reports         Report[]
  players         Player[]
}

model UserTeam {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  role      TeamRole
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

model Session {
  id          String      @id @default(cuid())
  title       String
  description String?
  date        DateTime
  type        SessionType @default(GENERAL)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  createdBy   String
  user        User        @relation("UserSessions", fields: [createdBy], references: [id], onDelete: Cascade)
  teamId      String
  team        Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)

  routines    SessionRoutine[]

  @@index([date])
  @@index([type])
  @@index([createdBy])
  @@index([teamId])
  @@index([teamId, date])
}

model Rival {
  id      String @id @default(cuid())
  teamId  String
  name    String
  logoUrl String?

  coach                 String?
  baseSystem            String?
  nextMatchDate         DateTime?
  nextMatchCompetition  String?

  planCharlaUrl   String?
  planReport      Json?   @default("{}")
  planVideos      Json?   @default("[]")
  planStats       Json?   @default("{}")
  planNotes       Json?   @default("{}")
  planVisibility  Json?   @default("{}")

  planSquad       Json?   @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@unique([teamId, name])
  @@index([nextMatchDate])
}

model PlayerFeedback {
  id        String   @id @default(cuid())
  teamId    String
  playerId  String
  subject   String?  @db.VarChar(120)
  text      String
  rating    Int?
  createdBy String
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId, playerId])
  @@index([teamId, createdAt])
}

model Place {
  id        String   @id @default(cuid())
  name      String
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, name])
  @@index([teamId])
}

model ExerciseKind {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  exercises  Exercise[]
}

model Exercise {
  id          String        @id @default(cuid())

  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  kindId      String?
  kind        ExerciseKind? @relation(fields: [kindId], references: [id], onDelete: SetNull)

  space       String?
  players     String?
  duration    String?
  description String?
  imageUrl    String?

  tags        String[]      @default([])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([userId, createdAt])
  @@index([userId, title])
  @@index([kindId])
}

model RPEEntry {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date      DateTime
  session   Int      @default(1)
  sessionLabel String?
  sessionUid   String?

  rpe       Int
  duration  Int?
  load      Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date, session], name: "userId_date_session")
  @@index([date])
  @@index([userId, date, session])
  @@index([date, session])
  @@index([sessionUid])
}

model WellnessEntry {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date            DateTime

  sleepQuality    Int
  sleepHours      Float?
  fatigue         Int
  muscleSoreness  Int
  stress          Int
  mood            Int
  comment         String?

  total           Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, date], name: "userId_date")
  @@index([date])
  @@index([userId, date])
}

model PlannerPrefs {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  rowLabels Json     @default("{}")
  places    Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
}

// ========= Clínico =========
model ClinicalEntry {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date      DateTime
  status    ClinicalStatus

  leaveStage LeaveStage?
  leaveKind  LeaveKind?

  diagnosis  String?
  bodyPart   String?
  laterality Laterality?
  mechanism  Mechanism?
  severity   Severity?

  illSystem        SystemAffected?
  illSymptoms      String?
  illContagious    Boolean?
  illIsolationDays Int?
  illAptitude      IllAptitude?
  feverMax         Float?

  startDate            DateTime?
  daysPlanned          Int?
  expectedReturn       DateTime?
  expectedReturnManual Boolean? @default(false)

  capMinutes          Int?
  noSprint            Boolean  @default(false)
  noChangeOfDirection Boolean  @default(false)
  gymOnly             Boolean  @default(false)
  noContact           Boolean  @default(false)

  notes        String?
  medSignature String?

  protocolObjectives String?
  protocolTasks      String?
  protocolControls   String?
  protocolCriteria   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date], name: "userId_date")
  @@index([date])
  @@index([status, date])
  @@index([leaveKind])
  @@index([bodyPart])
  @@index([userId, date])
}

// ========= Scouting =========
enum ScoutingStatus {
  ACTIVO
  WATCHLIST
  DESCARTADO
}

enum PlayerStatus {
  ACTIVO
  LESIONADO
  RECUPERACION
  ALTA_PARCIAL
  ALTA_TOTAL
}

model ScoutingCategory {
  id        String   @id @default(cuid())
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  nombre    String
  slug      String
  orden     Int      @default(0)
  color     String?
  activa    Boolean  @default(true)

  players   ScoutingPlayer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId, orden])
  @@unique([teamId, slug])
  @@unique([teamId, nombre])
}

model Player {
  id          String   @id @default(cuid())
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  name        String
  shirtNumber Int?
  position    String?
  photoUrl    String?
  birthDate   DateTime?

  status      PlayerStatus @default(ACTIVO)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([teamId])
}

model ScoutingPlayer {
  id           String            @id @default(cuid())
  teamId       String?
  team         Team?             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  fullName     String
  positions    String[]          @default([])
  club         String?
  estado       ScoutingStatus    @default(ACTIVO)

  categoriaId  String?
  categoria    ScoutingCategory? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)

  agentName    String?
  agentPhone   String?
  agentEmail   String?
  playerPhone  String?
  playerEmail  String?
  instagram    String?

  videos       String[]          @default([])
  notes        String?
  rating       Int?
  tags         String[]          @default([])

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([teamId])
  @@index([teamId, categoriaId])
  @@index([teamId, estado])
  @@index([teamId, fullName])
}

model Report {
  id        String   @id @default(cuid())
  teamId    String
  title     String
  summary   String?
  content   String
  type      String
  authorId  String
  visibleToDirectivo Boolean @default(true)
  createdAt DateTime @default(now())

  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([teamId, createdAt])
  @@index([authorId])
}

model TeamVideo {
  id        String   @id @default(cuid())
  teamId    String
  url       String
  title     String
  notes     String?
  type      String   // "propio" | "rival"
  visibleToDirectivo Boolean @default(true)
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId, createdAt])
}

model Routine {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  title       String
  description String?

  items    RoutineItem[]
  sessions SessionRoutine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model RoutineItem {
  id        String   @id @default(cuid())
  routineId String
  routine   Routine  @relation(fields: [routineId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([routineId])
}

model SessionRoutine {
  id        String   @id @default(cuid())
  sessionId String
  routineId String

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  routine Routine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, routineId])
}
