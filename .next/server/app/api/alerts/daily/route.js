"use strict";(()=>{var e={};e.id=7012,e.ids=[7012],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},97664:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>I,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>b,staticGenerationAsyncStorage:()=>N});var n={};t.r(n),t.d(n,{GET:()=>y,dynamic:()=>i});var s=t(49303),l=t(88716),u=t(60670),a=t(87070),o=t(13538);let i="force-dynamic";function d(e){return e.toISOString().slice(0,10)}function c(e,r){let t=new Date(e);return t.setDate(t.getDate()+r),t}function p(e){return e.length?e.reduce((e,r)=>e+r,0)/e.length:0}function m(e){let r=[Number(e.sleepQuality??0),Number(e.fatigue??0),Number(e.muscleSoreness??e.soreness??0),Number(e.stress??0),Number(e.mood??0)].filter(e=>e>0);return r.length?r.reduce((e,r)=>e+r,0)/r.length:0}function h(e){return null===e?"yellow":e>=-.5?"green":e>=-1?"yellow":"red"}function f(e,r){let t=e,n=r.sleepHours??null;return null!==n&&n<4&&(t="green"===t?"yellow":t),2>=Number(r.muscleSoreness??r.soreness??0)&&(t="red"),2>=Number(r.stress??0)&&(t="green"===t?"yellow":t),t}async function y(e){let{searchParams:r}=new URL(e.url),t=r.get("date")||d(new Date),n=d(c(new Date(t),-1)),s=d(c(new Date(t),-21));try{let e=await o.Z.wellnessEntry.findMany({where:{date:t},include:{user:{select:{id:!0,name:!0,email:!0}}},orderBy:{id:"asc"}});if(0===e.length)return a.NextResponse.json({date:t,count:0,items:[]});let r=e.map(e=>e.userId).filter(Boolean),l=await o.Z.wellnessEntry.findMany({where:{date:{gte:s,lt:t},userId:{in:r}},orderBy:[{userId:"asc"},{date:"asc"}]}),u=await o.Z.wellnessEntry.findMany({where:{date:n,userId:{in:r}}}),i=new Map;for(let e of u)i.set(e.userId,e);let d=await o.Z.rPEEntry.findMany({where:{date:n,userId:{in:r}}}),c=new Map;for(let e of d)c.set(e.userId,function(e){let r=e.load??e.srpe??(null!=e.duration?Number(e.rpe??0)*Number(e.duration):null);return null!=r?Math.round(Number(r)):0}(e));let y=new Map;for(let e of r){let r=l.filter(r=>r.userId===e).map(e=>m(e)).filter(e=>e>0);y.set(e,{mean:p(r),sd:function(e){let r=e.length;if(r<2)return 0;let t=p(e);return Math.sqrt(e.reduce((e,r)=>e+(r-t)*(r-t),0)/(r-1))}(r),n:r.length})}let g=e.map(e=>{let r=e.userId,n=e.user?.name||e.user?.email||e.userName||e.playerKey||"Jugador",s=m(e),l=y.get(r),u=l&&l.n>=7&&l.sd>0?(s-l.mean)/l.sd:null,a=h(u),o=f(a,e),d=c.get(r)||0,p=null,g=i.get(r);if(g){let e=m(g),t=y.get(r),n=t&&t.n>=7&&t.sd>0?(e-t.mean)/t.sd:null;p=f(h(n),g)}let{severity:w,reasons:N,suggestions:b}=function(e){let r=[],t=[],n="OK",{sdw:s,baseMean:l,z:u,color:a,sleepHours:o,soreness:i,stress:d,srpePrev:c,ydayColor:p}=e,m=l?(s-l)/l:null;return"red"===a&&null!==m&&m<=-.2&&(r.push("SDW en rojo y ca\xedda ≥20% vs baseline"),n="CRITICAL"),i<=2&&(r.push("Dolor muscular ≤2"),n="CRITICAL"),null!==o&&o<4&&c>900&&(r.push("Sue\xf1o <4h + sRPE alto ayer"),n="CRITICAL"),"red"===p&&"red"===a&&(r.push("2 d\xedas consecutivos en rojo"),n="CRITICAL"),"OK"===n&&(null!==u&&u<-.5&&u>=-1&&(r.push("Descenso moderado (Z entre -1.0 y -0.5)"),n="WARN"),null!==o&&o>=4&&o<5&&(r.push("Sue\xf1o 4–5h"),n="WARN"),d>=2&&d<=3&&(r.push("Estr\xe9s 2–3"),n="WARN")),"OK"!==n&&(i<=2?t.push("Screening con fisio; reducir exc\xe9ntricos/altas velocidades; priorizar isom\xe9tricos."):null!==o&&o<4?t.push("Reducir volumen 20–30%; +20’ de recovery (movilidad + respiraci\xf3n)."):d<=2?t.push("Micro-ajuste de volumen; educaci\xf3n de sue\xf1o/recuperaci\xf3n."):t.push("Ajustar carga del d\xeda (menor volumen/intensidad) y monitorear.")),{severity:n,reasons:r,suggestions:t}}({sdw:s,baseMean:l?.mean??null,z:u,color:o,sleepHours:null!=e.sleepHours?Number(e.sleepHours):null,soreness:Number(e.muscleSoreness??e.soreness??0),stress:Number(e.stress??0),srpePrev:d,ydayColor:p});return{userId:r,name:n,date:t,sdw:Number(s.toFixed(2)),baselineMean:l?.mean?Number(l.mean.toFixed(2)):null,z:null!==u?Number(u.toFixed(2)):null,color:o,srpePrev:d,severity:w,reasons:N,suggestions:b}}),w={CRITICAL:0,WARN:1,OK:2};return g.sort((e,r)=>{let t=w[e.severity]-w[r.severity];if(0!==t)return t;let n=e.z??0,s=r.z??0;return n-s}),a.NextResponse.json({date:t,count:g.length,items:g})}catch(e){return console.error(e),a.NextResponse.json({error:e?.message||"Error generando alertas"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/alerts/daily/route",pathname:"/api/alerts/daily",filename:"route",bundlePath:"app/api/alerts/daily/route"},resolvedPagePath:"/Users/Fran/ctbrain-14/src/app/api/alerts/daily/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:N,serverHooks:b}=g,I="/api/alerts/daily/route";function v(){return(0,u.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:N})}},13538:(e,r,t)=>{t.d(r,{Z:()=>l,_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]}),l=s}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[8948,5972],()=>t(97664));module.exports=n})();