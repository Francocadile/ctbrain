"use strict";(()=>{var e={};e.id=6199,e.ids=[6199],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},2564:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>L,patchFetch:()=>T,requestAsyncStorage:()=>C,routeModule:()=>v,serverHooks:()=>x,staticGenerationAsyncStorage:()=>R});var n={};r.r(n),r.d(n,{POST:()=>y,dynamic:()=>d});var i=r(49303),s=r(88716),a=r(60670),o=r(87070),u=r(13538),l=r(70528);let d="force-dynamic";function c(e){let[t,r,n]=e.split("-").map(Number);return new Date(Date.UTC(t,r-1,n))}function p(e){let t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),r=t.getUTCDay()||7;return 1!==r&&t.setUTCDate(t.getUTCDate()-(r-1)),t.setUTCHours(0,0,0,0),t}function f(e,t){let r=c(e);return r.setUTCHours("morning"===t?9:15,0,0,0),r.toISOString()}function m(e){return`[DAYFLAG:${e}]`}function g(e,t){return`[GRID:${e}:${t}]`}let h=new Set(["PRE ENTREN0","F\xcdSICO","T\xc9CNICOâ€“T\xc1CTICO","COMPENSATORIO","LUGAR","HORA","VIDEO","NOMBRE SESI\xd3N"]);function w(e){return e.trim().toLowerCase().replace(/\s+/g,"_")}async function y(e){let t=await (0,l.V)(["CT","ADMIN"]),r=t?.user?.id||t?.id||t?.userId;if(!r)return o.NextResponse.json({ok:!1,error:"Usuario no identificado"},{status:401});let n=await e.json().catch(()=>({})),i=n.csvText||"",s=n.targetStart||null,a=!!n.overwrite,d=!!n.dryRun;if(!i.trim())return o.NextResponse.json({error:"csvText vac\xedo"},{status:400});let y=function(e){let t=[],r=0,n="",i=[],s=!1,a=()=>{i.push(n),n=""},o=()=>{t.push(i),i=[]};for(;r<e.length;){let t=e[r];if(s){if('"'===t){if('"'===e[r+1]){n+='"',r+=2;continue}s=!1,r++;continue}n+=t,r++;continue}if('"'===t){s=!0,r++;continue}if(","===t){a(),r++;continue}if("\r"===t){r++;continue}if("\n"===t){a(),o(),r++;continue}n+=t,r++}return a(),(i.length>1||1===i.length&&""!==i[0])&&o(),t}(i);if(!y.length)return o.NextResponse.json({error:"CSV sin filas"},{status:400});let v=y[0].map(w);for(let e of["date","turn"])if(!v.includes(e))return o.NextResponse.json({error:`Falta columna requerida: ${e}`},{status:400});let C=y.slice(1).map(e=>{let t={};return v.forEach((r,n)=>t[r]=(e[n]??"").trim()),t.turn=(t.turn||"").toLowerCase(),t.day_flag&&(t.day_flag=String(t.day_flag).toUpperCase()),t}),{actions:R,warnings:x,errors:L}=function(e){let t=[],r=[],n=[];for(let i=0;i<e.length;i++){let s=e[i],a=`fila ${i+2}`;if(!/^\d{4}-\d{2}-\d{2}$/.test(s.date||"")){n.push(`${a}: date inv\xe1lida`);continue}if("morning"!==s.turn&&"afternoon"!==s.turn){n.push(`${a}: turn debe ser morning|afternoon`);continue}let o=(s.day_flag||"").toUpperCase();"PARTIDO"===o||"LIBRE"===o?t.push({kind:"FLAG",ymd:s.date,turn:s.turn,flag:o,rival:s.flag_rival||void 0,logo:s.flag_logo||void 0}):"NONE"===o&&t.push({kind:"CLEAR_FLAG",ymd:s.date,turn:s.turn});let u=(s.row||"").trim();if(u){if(!h.has(u)){n.push(`${a}: row inv\xe1lido "${u}"`);continue}let e=(s.title||"").trim();if("VIDEO"===u){let t=(s.video_label||"").trim(),n=(s.video_url||"").trim();if(!t&&!n&&!e){r.push(`${a}: VIDEO vac\xedo`);continue}e=t&&n?`${t}|${n}`:n||t,n&&!/^https?:\/\//i.test(n)&&r.push(`${a}: URL de video no parece v\xe1lida`)}"LUGAR"===u&&s.place&&(e=s.place.trim()),"HORA"===u&&s.time&&(e=s.time.trim()),e?t.push({kind:"CELL",ymd:s.date,turn:s.turn,row:u,value:e}):t.push({kind:"CLEAR_CELL",ymd:s.date,turn:s.turn,row:u})}}return{actions:t,warnings:r,errors:n}}(C);if(L.length)return o.NextResponse.json({ok:!1,errors:L,warnings:x},{status:400});let T=0;if(s){let e=p(C.map(e=>e.date).filter(Boolean).map(c).sort((e,t)=>e.getTime()-t.getTime())[0]||new Date);T=Math.round((p(c(s)).getTime()-e.getTime())/864e5)}if(d){let e={cell_set:R.filter(e=>"CELL"===e.kind).length,cell_clear:R.filter(e=>"CLEAR_CELL"===e.kind).length,flag_set:R.filter(e=>"FLAG"===e.kind).length,flag_clear:R.filter(e=>"CLEAR_FLAG"===e.kind).length};return o.NextResponse.json({ok:!0,dryRun:!0,diffDays:T,counts:e,warnings:x})}try{let e=await u._.$transaction(async e=>{let t=0,n=0,i=0;for(let l of R){let d=T?function(e){let t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0");return`${t}-${r}-${n}`}(function(e,t){let r=new Date(e);return r.setUTCDate(r.getUTCDate()+t),r}(c(l.ymd),T)):l.ymd;if("CLEAR_FLAG"===l.kind){let t=`${m(l.turn)} | ${d}`;i+=await e.session.deleteMany({where:{description:t}}).then(e=>e.count);continue}if("FLAG"===l.kind){var s,o,u;let c=`${m(l.turn)} | ${d}`,p=(s=l.flag,o=l.rival,u=l.logo,"PARTIDO"===s?`PARTIDO|${o??""}|${u??""}`:"LIBRE"===s?"LIBRE":""),g=f(d,l.turn);a&&(i+=await e.session.deleteMany({where:{description:c}}).then(e=>e.count));let h=await e.session.findFirst({where:{description:c}});if(h)await e.session.update({where:{id:h.id},data:{title:p,date:new Date(g)}}),n++;else{let n={title:p,description:c,date:new Date(g),type:"GENERAL",user:{connect:{id:r}},createdBy:r};await e.session.create({data:n}),t++}continue}if("CLEAR_CELL"===l.kind){let t=`${g(l.turn,l.row)} | ${d}`;i+=await e.session.deleteMany({where:{description:t}}).then(e=>e.count);continue}if("CELL"===l.kind){let s=`${g(l.turn,l.row)} | ${d}`,o=f(d,l.turn);a&&(i+=await e.session.deleteMany({where:{description:s}}).then(e=>e.count));let u=await e.session.findFirst({where:{description:s}});if(u)await e.session.update({where:{id:u.id},data:{title:l.value,date:new Date(o)}}),n++;else{let n={title:l.value,description:s,date:new Date(o),type:"GENERAL",user:{connect:{id:r}},createdBy:r};await e.session.create({data:n}),t++}continue}}return{created:t,updated:n,deleted:i}});return o.NextResponse.json({ok:!0,...e,warnings:x,diffDays:T})}catch(e){return console.error(e),o.NextResponse.json({ok:!1,error:e?.message||"Error aplicando CSV"},{status:500})}}let v=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/sessions/import-csv/route",pathname:"/api/sessions/import-csv",filename:"route",bundlePath:"app/api/sessions/import-csv/route"},resolvedPagePath:"/Users/Fran/ctbrain-14/src/app/api/sessions/import-csv/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:C,staticGenerationAsyncStorage:R,serverHooks:x}=v,L="/api/sessions/import-csv/route";function T(){return(0,a.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:R})}},53797:(e,t)=>{t.Z=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},38238:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let n=Reflect.get(e,t,r);return"function"==typeof n?n.bind(e):n}static set(e,t,r,n){return Reflect.set(e,t,r,n)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},70528:(e,t,r)=>{r.d(t,{V:()=>s,m:()=>a});var n=r(75571),i=r(95456);async function s(e){let t=await (0,n.getServerSession)(i.L);if(!t?.user?.id)throw new Response("No autenticado",{status:401});let r=t.user.role;if(!r||!e.includes(r))throw new Response("No autorizado",{status:403});return t}async function a(){let e=await (0,n.getServerSession)(i.L);if(!e?.user?.id)throw new Response("No autenticado",{status:401});return e}},95456:(e,t,r)=>{r.d(t,{L:()=>u});var n=r(53797),i=r(53524),s=r(42023),a=r.n(s);let o=new i.PrismaClient,u={session:{strategy:"jwt"},providers:[(0,n.Z)({name:"credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){let t=(e?.email||"").trim().toLowerCase(),r=(e?.password||"").toString();if(!t)return null;let n=await o.user.findUnique({where:{email:t},select:{id:!0,email:!0,name:!0,role:!0,isApproved:!0,passwordHash:!0}});if(!n||!n.passwordHash||!await a().compare(r,n.passwordHash))return null;let i=(await o.userTeam.findMany({where:{userId:n.id},select:{teamId:!0}})).map(e=>e.teamId),s=i.length>0?i[0]:null;return{id:n.id,email:n.email,name:n.name??n.email,role:n.role,isApproved:n.isApproved,teamIds:i,currentTeamId:s}}})],pages:{signIn:"/login"},callbacks:{async jwt({token:e,user:t}){if(t){let{role:r,isApproved:n,teamIds:i=[],currentTeamId:s=null}=t;e.role=r,e.isApproved=n,e.teamIds=i,e.currentTeamId=s??(i.length>0?i[0]:null)}else e.teamIds=e.teamIds??[],e.currentTeamId=e.currentTeamId??null;return e},async session({session:e,token:t}){e.user=e.user||{},e.user.id=t.sub,e.user.role=t.role,e.user.isApproved=t.isApproved??null;let r=Array.isArray(t.teamIds)?t.teamIds:[];return e.user.teamIds=r,e.user.currentTeamId=t.currentTeamId??null,e}}}},13538:(e,t,r)=>{r.d(t,{Z:()=>s,_:()=>i});var n=r(53524);let i=globalThis.prisma??new n.PrismaClient({log:["error"]}),s=i}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,330,2023,5571],()=>r(2564));module.exports=n})();