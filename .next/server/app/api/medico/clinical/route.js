"use strict";(()=>{var e={};e.id=8959,e.ids=[8959],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},38624:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>M,patchFetch:()=>R,requestAsyncStorage:()=>D,routeModule:()=>C,serverHooks:()=>h,staticGenerationAsyncStorage:()=>S});var a={};r.r(a),r.d(a,{GET:()=>x,POST:()=>v,dynamic:()=>d,revalidate:()=>p,runtime:()=>c});var n=r(49303),l=r(88716),o=r(60670),s=r(87070),i=r(13538),u=r(20330);let c="nodejs",d="force-dynamic",p=0;function m(e){let t=new Date(e);return t.setHours(0,0,0,0),t.toISOString().slice(0,10)}function y(e){if(!e)return null;let t=/^(\d{4})-(\d{2})-(\d{2})$/.exec(e);if(!t)return null;let[r,a,n,l]=t,o=new Date(Number(a),Number(n)-1,Number(l));return isNaN(o.getTime())?null:o}function g(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function f(e){let t=g(e);return t.setDate(t.getDate()+1),t}async function x(e){let t=await (0,u.getToken)({req:e,secret:process.env.NEXTAUTH_SECRET}),r=t?.role;if(!t||!["MEDICO","CT","ADMIN"].includes(r??""))return s.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:a}=e.nextUrl,n=a.get("date"),l=a.get("mode")||"",o=y(n)??(n?new Date(n):new Date),c=g(o),d=f(o);if("day-only"===l){let e=(await i._.clinicalEntry.findMany({where:{date:{gte:c,lt:d}},include:{user:{select:{name:!0,email:!0}}},orderBy:[{date:"desc"},{updatedAt:"desc"}]})).map(e=>({id:e.id,userId:e.userId,userName:e.user?.name||e.user?.email||"—",date:m(e.date),status:e.status,leaveStage:e.leaveStage,leaveKind:e.leaveKind,diagnosis:e.diagnosis,bodyPart:e.bodyPart,laterality:e.laterality,mechanism:e.mechanism,severity:e.severity,illSystem:e.illSystem,illSymptoms:e.illSymptoms,illContagious:e.illContagious,illIsolationDays:e.illIsolationDays,illAptitude:e.illAptitude,feverMax:e.feverMax,startDate:e.startDate?m(e.startDate):null,expectedReturn:e.expectedReturn?m(e.expectedReturn):null,expectedReturnManual:e.expectedReturnManual,capMinutes:e.capMinutes,noSprint:e.noSprint,noChangeOfDirection:e.noChangeOfDirection,gymOnly:e.gymOnly,noContact:e.noContact,notes:e.notes,medSignature:e.medSignature,protocolObjectives:e.protocolObjectives,protocolTasks:e.protocolTasks,protocolControls:e.protocolControls,protocolCriteria:e.protocolCriteria}));return s.NextResponse.json(e,{headers:{"cache-control":"no-store"}})}let p=f(o),x=await i._.clinicalEntry.findMany({where:{date:{lt:p}},include:{user:{select:{name:!0,email:!0}}},orderBy:[{userId:"asc"},{date:"desc"},{updatedAt:"desc"}]}),v=new Map;for(let e of x)v.has(e.userId)||v.set(e.userId,e);let C=Array.from(v.values()).filter(e=>"ALTA"!==e.status),D=await i._.clinicalEntry.findMany({where:{date:{gte:c,lt:d},status:"ALTA"},include:{user:{select:{name:!0,email:!0}}},orderBy:[{updatedAt:"desc"}]}),S={};for(let e of C)S[e.userId]=e;for(let e of D)S[e.userId]=e;let h=Object.values(S).map(e=>({id:e.id,userId:e.userId,userName:e.user?.name||e.user?.email||"—",date:m(e.date),status:e.status,leaveStage:e.leaveStage,leaveKind:e.leaveKind,diagnosis:e.diagnosis,bodyPart:e.bodyPart,laterality:e.laterality,mechanism:e.mechanism,severity:e.severity,illSystem:e.illSystem,illSymptoms:e.illSymptoms,illContagious:e.illContagious,illIsolationDays:e.illIsolationDays,illAptitude:e.illAptitude,feverMax:e.feverMax,startDate:e.startDate?m(e.startDate):null,expectedReturn:e.expectedReturn?m(e.expectedReturn):null,expectedReturnManual:e.expectedReturnManual,capMinutes:e.capMinutes,noSprint:e.noSprint,noChangeOfDirection:e.noChangeOfDirection,gymOnly:e.gymOnly,noContact:e.noContact,notes:e.notes,medSignature:e.medSignature,protocolObjectives:e.protocolObjectives,protocolTasks:e.protocolTasks,protocolControls:e.protocolControls,protocolCriteria:e.protocolCriteria})),M={BAJA:0,REINTEGRO:1,LIMITADA:2,ALTA:3},R=e=>{if(!e)return null;let[t,r,a]=e.split("-").map(Number),n=new Date(t,(r||1)-1,a||1);return n.setHours(0,0,0,0),isNaN(n.getTime())?null:n};return h.sort((e,t)=>{let r=M[e.status]??99,a=M[t.status]??99;if(r!==a)return r-a;let n=R(e.expectedReturn),l=R(t.expectedReturn);if(n&&l){let e=n.getTime()-l.getTime();if(0!==e)return e}else if(n&&!l)return -1;else if(!n&&l)return 1;return(e.userName||"").localeCompare(t.userName||"")}),s.NextResponse.json(h,{headers:{"cache-control":"no-store"}})}async function v(e){let t=await (0,u.getToken)({req:e,secret:process.env.NEXTAUTH_SECRET}),r=t?.role;if(!t||!["MEDICO","ADMIN"].includes(r??""))return s.NextResponse.json({error:"Unauthorized"},{status:401});try{let t=await e.json(),r=t.userId;if(!r)return s.NextResponse.json({error:"Falta userId (jugador)"},{status:400});let a=await i._.user.findUnique({where:{id:r},select:{id:!0}});if(!a)return s.NextResponse.json({error:"userId inv\xe1lido (no existe el usuario)"},{status:400});let n="string"==typeof t.date?t.date:void 0,l=y(n)??(t.date?new Date(t.date):new Date),o=g(l),u=f(l),c=y(t.startDate)??(t.startDate?new Date(t.startDate):null),d="number"==typeof t.daysEstimated?t.daysEstimated:"number"==typeof t.daysMax?t.daysMax:null,p=y(t.expectedReturn)??(t.expectedReturn?new Date(t.expectedReturn):null),x="boolean"==typeof t.expectedReturnManual&&t.expectedReturnManual;if(!p&&c&&Number.isInteger(d)){let e=new Date(c);e.setDate(e.getDate()+Number(d)),p=e,x=!1}let v={userId:a.id,date:o,status:t.status,leaveStage:t.leaveStage??null,leaveKind:t.leaveKind??null,diagnosis:t.diagnosis??null,bodyPart:t.bodyPart??null,laterality:t.laterality??null,mechanism:t.mechanism??null,severity:t.severity??null,illSystem:t.illSystem??null,illSymptoms:t.illSymptoms??null,illContagious:"boolean"==typeof t.illContagious?t.illContagious:null,illIsolationDays:"number"==typeof t.illIsolationDays?t.illIsolationDays:null,illAptitude:t.illAptitude??null,feverMax:"number"==typeof t.feverMax||null===t.feverMax?t.feverMax:null,startDate:c,expectedReturn:p,expectedReturnManual:x,capMinutes:"number"==typeof t.capMinutes?t.capMinutes:null,noSprint:!!t.noSprint,noChangeOfDirection:!!t.noChangeOfDirection,gymOnly:!!t.gymOnly,noContact:!!t.noContact,notes:t.notes??null,medSignature:t.medSignature??null,protocolObjectives:t.protocolObjectives??null,protocolTasks:t.protocolTasks??null,protocolControls:t.protocolControls??null,protocolCriteria:t.protocolCriteria??null},C={status:{set:v.status},leaveStage:{set:v.leaveStage},leaveKind:{set:v.leaveKind},diagnosis:{set:v.diagnosis},bodyPart:{set:v.bodyPart},laterality:{set:v.laterality},mechanism:{set:v.mechanism},severity:{set:v.severity},illSystem:{set:v.illSystem},illSymptoms:{set:v.illSymptoms},illContagious:{set:v.illContagious},illIsolationDays:{set:v.illIsolationDays},illAptitude:{set:v.illAptitude},feverMax:{set:v.feverMax},startDate:{set:v.startDate},expectedReturn:{set:v.expectedReturn},expectedReturnManual:{set:v.expectedReturnManual},capMinutes:{set:v.capMinutes},noSprint:{set:v.noSprint},noChangeOfDirection:{set:v.noChangeOfDirection},gymOnly:{set:v.gymOnly},noContact:{set:v.noContact},notes:{set:v.notes},medSignature:{set:v.medSignature},protocolObjectives:{set:v.protocolObjectives},protocolTasks:{set:v.protocolTasks},protocolControls:{set:v.protocolControls},protocolCriteria:{set:v.protocolCriteria}},D=await i._.clinicalEntry.findFirst({where:{userId:a.id,date:{gte:o,lt:u}},select:{id:!0}}),S=D?await i._.clinicalEntry.update({where:{id:D.id},data:C}):await i._.clinicalEntry.create({data:v});return s.NextResponse.json({ok:!0,id:S.id,status:S.status,date:m(S.date)},{status:D?200:201})}catch(e){return console.error("POST /api/medico/clinical error:",e),s.NextResponse.json({error:"Error creando/actualizando parte cl\xednico"},{status:500})}}let C=new n.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/medico/clinical/route",pathname:"/api/medico/clinical",filename:"route",bundlePath:"app/api/medico/clinical/route"},resolvedPagePath:"/Users/Fran/ctbrain-14/src/app/api/medico/clinical/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:D,staticGenerationAsyncStorage:S,serverHooks:h}=C,M="/api/medico/clinical/route";function R(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:S})}},13538:(e,t,r)=>{r.d(t,{Z:()=>l,_:()=>n});var a=r(53524);let n=globalThis.prisma??new a.PrismaClient({log:["error"]}),l=n}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,330],()=>r(38624));module.exports=a})();