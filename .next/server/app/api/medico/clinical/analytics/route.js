"use strict";(()=>{var e={};e.id=8501,e.ids=[8501],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},24031:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>D,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>x});var s=r(49303),n=r(88716),i=r(60670),u=r(87070),o=r(20330),l=r(13538);function d(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function c(e){let t=new Date(e);return t.setHours(23,59,59,999),t}function p(e){let t=new Date(e);return t.setHours(0,0,0,0),t.toISOString().slice(0,10)}function m(e){let[t,r,a]=e.split("-").map(Number);return new Date(t,(r||1)-1,a||1)}function h(e,t){return Math.max(0,Math.round((c(t).getTime()-d(e).getTime())/864e5))}async function x(e){let t=await (0,o.getToken)({req:e,secret:process.env.NEXTAUTH_SECRET});if(!t)return u.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.role;if(!("CT"===r||"ADMIN"===r||"MEDICO"===r))return u.NextResponse.json({error:"Forbidden"},{status:403});let a=new URL(e.url),s=a.searchParams.get("start"),n=a.searchParams.get("end"),i=new Date,x=new Date(i.getFullYear(),i.getMonth(),1),g=new Date(i.getFullYear(),i.getMonth()+1,0),y=s?d(m(s)):d(x),f=n?c(m(n)):c(g),w=await l.Z.clinicalEntry.findMany({where:{date:{gte:y,lte:f}},select:{id:!0,userId:!0,date:!0,status:!0,leaveKind:!0,bodyPart:!0,mechanism:!0,severity:!0,startDate:!0,expectedReturn:!0,user:{select:{name:!0,email:!0}}},orderBy:[{date:"desc"},{createdAt:"desc"}]}),v=w.length,D=new Set(w.map(e=>e.userId)).size,R={BAJA:0,REINTEGRO:0,LIMITADA:0,ALTA:0};w.forEach(e=>{let t=e.status;null!=R[t]&&(R[t]+=1)});let I=new Map,P=new Map;w.forEach(e=>{e.bodyPart&&I.set(e.bodyPart,(I.get(e.bodyPart)||0)+1),e.mechanism&&P.set(e.mechanism,(P.get(e.mechanism)||0)+1)});let b=[...I.entries()].sort((e,t)=>t[1]-e[1]).slice(0,8).map(([e,t])=>({name:e,count:t})),M=[...P.entries()].sort((e,t)=>t[1]-e[1]).slice(0,8).map(([e,t])=>({name:e,count:t})),A=[];w.forEach(e=>{e.startDate&&e.expectedReturn&&A.push(h(e.startDate,e.expectedReturn))});let E=A.length>0?Math.round(A.reduce((e,t)=>e+t,0)/A.length):null,T=new Map;w.forEach(e=>{let t=e.user?.name||e.user?.email||e.userId,r=h(e.startDate||e.date,e.expectedReturn||f),a=T.get(e.userId)||{userId:e.userId,name:t,daysOut:0,episodes:0};a.daysOut+=r,a.episodes+=1,T.set(e.userId,a)});let q=[...T.values()].sort((e,t)=>t.daysOut-e.daysOut).slice(0,10),O=w.slice(0,20).map(e=>({id:e.id,userId:e.userId,userName:e.user?.name||e.user?.email||e.userId,date:p(e.date),status:e.status,bodyPart:e.bodyPart,mechanism:e.mechanism,severity:e.severity,startDate:e.startDate?p(e.startDate):null,expectedReturn:e.expectedReturn?p(e.expectedReturn):null}));return u.NextResponse.json({range:{start:p(y),end:p(f)},totals:{episodes:v,playersAffected:D,avgEstimatedDays:E,statusCounts:R},bodyPartTop:b,mechanismTop:M,topPlayersByDaysOut:q,recent:O})}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/medico/clinical/analytics/route",pathname:"/api/medico/clinical/analytics",filename:"route",bundlePath:"app/api/medico/clinical/analytics/route"},resolvedPagePath:"/Users/Fran/ctbrain-14/src/app/api/medico/clinical/analytics/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:w}=g,v="/api/medico/clinical/analytics/route";function D(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},13538:(e,t,r)=>{r.d(t,{Z:()=>n,_:()=>s});var a=r(53524);let s=globalThis.prisma??new a.PrismaClient({log:["error"]}),n=s}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,330],()=>r(24031));module.exports=a})();